<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>Flintforge Account Security</title>
  <link rel="icon" type="image/png" href="https://flintforge.pnc3.net/res/favicon.png">
  <style>
    :root {
      --bg: #1a1a1a; --text: #e0e0e0; --input-bg: #2d2d2d; --border: #444;
      --btn: #966b42; --btn-hover: #855e39;
    }
    @media (prefers-color-scheme: light) {
      :root { --bg: #f7f7f7; --text: #333; --input-bg: #fff; --border: #ccc; }
    }
    body {
      background: var(--bg); color: var(--text); font-family: sans-serif;
      max-width: 380px; margin: 40px auto; padding: 20px;
      background-image: url('https://flintforge.pnc3.net/res/bkg.png');
      background-repeat: repeat;
    }
    input, button {
      width: 100%; padding: 10px; margin: 8px 0; font-size: 16px;
      border-radius: 4px; border: 1px solid var(--border); box-sizing: border-box;
      background: var(--input-bg); color: var(--text);
    }
    input::placeholder { color: #888; }
    input.invalid { border-color: #c42f2f; }
    button { background: var(--btn); color: #fff; cursor: pointer; font-weight: bold; }
    button:hover { background: var(--btn-hover); }
    #status { margin-top: 12px; font-weight: bold; }

    /* Warnings */
    .warning {
      display: none;
      background: #4a1c1c;
      color: #ffdddd;
      padding: 10px;
      margin: 10px 0;
      border-radius: 6px;
      border: 1px solid #c42f2f;
      font-size: 14px;
      text-align: center;
    }
    .warning.show { display: block; }
  </style>
</head>
<body>
  <div style="text-align: center; margin: 20px 0;">
    <button onclick="location.href = 'https://flintforge.pnc3.net/account'"
            style="padding: 10px 28px; font-size: 16px; background: #966b42; color: white; border: none; border-radius: 4px; cursor: pointer;">
      Back
    </button>
  </div>

  <h2>Flintforge Security Config</h2>
  <h5>May take up to a minute, do not switch tabs*</h5>

  <input id="email" placeholder="Email" type="email" required>
  <input id="old" placeholder="Current Password" type="password" required>
  <input id="new" placeholder="New Password" type="password" required
         oninput="validateNewPassword(this.value)">

  <!-- Delete Account Warning -->
  <div id="deleteWarning" class="warning">
    <strong>WARNING:</strong> Setting the new password to <code>delete_account</code>
    will <strong>permanently delete</strong> your account.
  </div>

  <!-- Length Warnings -->
  <div id="lengthWarning" class="warning">
    <strong>Error:</strong> New password must be <strong>6–48 characters</strong>.
  </div>

  <button onclick="go()">Update</button>

  <h4 style="margin-top: 16px; color: #ff6b6b;">
    To delete account, set New Password to: <code>delete_account</code>
  </h4>

  <div id="status"></div>

  <script>
    const newPassInput = document.getElementById('new');
    const deleteWarning = document.getElementById('deleteWarning');
    const lengthWarning = document.getElementById('lengthWarning');

    function validateNewPassword(value) {
      const isDeleteCommand = value.toLowerCase().includes('delete_account');
      const isTooShort = value.length > 0 && value.length < 6;
      const isTooLong = value.length > 48;

      // Show delete warning
      deleteWarning.classList.toggle('show', isDeleteCommand);

      // Show length warning + red border
      if (isDeleteCommand) {
        // Allow delete_account regardless of length
        lengthWarning.classList.remove('show');
        newPassInput.classList.remove('invalid');
      } else if (isTooShort || isTooLong) {
        lengthWarning.classList.add('show');
        newPassInput.classList.add('invalid');
      } else {
        lengthWarning.classList.remove('show');
        newPassInput.classList.remove('invalid');
      }
    }

    async function go() {
      const email = document.getElementById('email').value.trim();
      const oldPass = document.getElementById('old').value;
      const newPass = document.getElementById('new').value;
      const status = document.getElementById('status');

      if (!email || !oldPass || !newPass) {
        status.textContent = 'Fill all fields';
        status.style.color = 'red';
        return;
      }

      // Allow delete_account even if length invalid
      if (newPass !== 'delete_account') {
        if (newPass.length < 6 || newPass.length > 48) {
          status.textContent = 'Password must be 6–48 characters';
          status.style.color = 'red';
          return;
        }
      }

      status.textContent = 'Working...';
      status.style.color = 'blue';

      try {
        const response = await fetch('http://74.208.127.147:8084/change-password', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ email, oldPass, newPass })
        });
        const data = await response.json();

        status.textContent = data.status === 'OK' ? 'Success!' : `Failed: ${data.status}`;
        status.style.color = data.status === 'OK' ? 'green' : 'red';
      } catch (err) {
        status.textContent = 'Network error';
        status.style.color = 'red';
      }
    }
  </script>
</body>
</html>
